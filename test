Sub Slice_Entire_TDVIV()
    Dim fd As FileDialog: Set fd = Application.FileDialog(msoFileDialogFilePicker)
    Dim jsonText As String, tdvivBlock As String
    Dim fso As Object, jsonFile As Object
    Dim regEx As Object: Set regEx = CreateObject("VBScript.RegExp")
    Dim matches As Object, parentMatches As Object
    Dim i As Long, startPos As Long, endPos As Long
    
    ' 1. Select and Read the JSON File
    With fd
        .Title = "Select PX Output JSON (Output 4 Structure)"
        If .Show = -1 Then
            Set fso = CreateObject("Scripting.FileSystemObject")
            Set jsonFile = fso.OpenTextFile(.SelectedItems(1), 1)
            jsonText = jsonFile.ReadAll: jsonFile.Close
        Else: Exit Sub
        End If
    End With

    ' --- STEP 1: Isolate the TDVIV Block ---
    ' Targets the final segment "timeDependentVectorInVectors"
    ' Greedy capture ensures variables at the very end are included
    regEx.Pattern = """timeDependentVectorInVectors""\s*:\s*\[([\s\S]+)\]"
    regEx.Global = False
    regEx.IgnoreCase = True
    Set matches = regEx.Execute(jsonText)
    
    If matches.Count > 0 Then
        tdvivBlock = matches(0).subMatches(0)
        Debug.Print "=== TDVIV RAW BLOCK ISOLATED ==="
        
        ' --- STEP 2: Find Group Name Positions ---
        Dim regExParent As Object: Set regExParent = CreateObject("VBScript.RegExp")
        regExParent.Pattern = """name""\s*:\s*""([^""]+)""\s*,\s*""vectors""\s*:\s*\["
        regExParent.Global = True
        Set parentMatches = regExParent.Execute(tdvivBlock)
        
        ' --- STEP 3: Slice and Print Segments ---
        For i = 0 To parentMatches.Count - 1
            Dim groupName As String: groupName = parentMatches(i).subMatches(0)
            
            ' Determine slice boundaries using FirstIndex
            startPos = parentMatches(i).FirstIndex
            If i < parentMatches.Count - 1 Then
                endPos = parentMatches(i + 1).FirstIndex
            Else
                endPos = Len(tdvivBlock)
            End If
            
            ' Extract the raw segment text
            Dim segmentText As String
            segmentText = Mid(tdvivBlock, startPos + 1, endPos - startPos)
            
            Debug.Print "----------------------------------------------------"
            Debug.Print "SEGMENT PARENT: " & groupName
            Debug.Print "SEGMENT DATA:"
            Debug.Print segmentText
        Next
        
        MsgBox "TDVIV Segmented! Check the Immediate Window (Ctrl+G).", vbInformation
    Else
        MsgBox "Could not find the 'timeDependentVectorInVectors' segment.", vbCritical
    End If
End Sub
