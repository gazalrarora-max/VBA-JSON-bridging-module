Sub Head_Macro_Upload_PX_Outputs()
    Dim wsSetup As Worksheet: Set wsSetup = ThisWorkbook.Sheets("Setup")
    Dim fd As FileDialog: Set fd = Application.FileDialog(msoFileDialogFilePicker)
    Dim jsonText As String, fso As Object, jsonFile As Object
    Dim nextRow As Long: nextRow = 10
    
    ' 1. Select the Sample JSON Output
    With fd
        .Title = "Select Sample PX Output JSON"
        If .Show = -1 Then
            Set fso = CreateObject("Scripting.FileSystemObject")
            Set jsonFile = fso.OpenTextFile(.SelectedItems(1), 1)
            jsonText = jsonFile.ReadAll: jsonFile.Close
        Else: Exit Sub
        End If
    End With

    ' 2. Clear Columns R, S, and T (Rows 10+)
    wsSetup.Range("R10:T" & wsSetup.Rows.Count).ClearContents
    Application.ScreenUpdating = False

    ' 3. Call All Workers in sequence
    Call Worker1_Scan_Direct_Vectors(jsonText, nextRow)
    Call Worker2_Scan_Vectors_In_Vectors(jsonText, nextRow)
    Call Worker3_Scan_Time_Dependent_Vectors(jsonText, nextRow)

    Application.ScreenUpdating = True
    MsgBox "PX Output List Fully Updated! Total: " & (nextRow - 10) & " items found.", vbInformation
End Sub

Sub Worker1_Scan_Direct_Vectors(ByVal json As String, ByRef nextRow As Long)
    Dim regEx As Object: Set regEx = CreateObject("VBScript.RegExp")
    Dim ws As Worksheet: Set ws = Sheets("Setup")
    Dim matches As Object, subMatches As Object, m As Object, sm As Object
    
    ' Pattern: Look for "getOutput" followed by the VERY FIRST "vectors" array
    ' The [^\]]*? ensures we stop at the first closing bracket of the array
    regEx.Pattern = """getOutput""\s*:\s*\{[\s\S]*?""vectors""\s*:\s*\[([\s\S]*?)\]"
    regEx.Global = False
    regEx.IgnoreCase = True
    
    Set matches = regEx.Execute(json)
    
    If matches.Count > 0 Then
        Dim vectorBlock As String: vectorBlock = matches(0).subMatches(0)
        
        ' Secondary Regex: Extract all "name" values from this specific block
        Dim nameReg As Object: Set nameReg = CreateObject("VBScript.RegExp")
        nameReg.Pattern = """name""\s*:\s*""([^""]+)"""
        nameReg.Global = True
        
        Set subMatches = nameReg.Execute(vectorBlock)
        
        ' 4. Populate Excel
        If subMatches.Count > 0 Then
            For Each sm In subMatches
                ws.Cells(nextRow, "R").Value = sm.subMatches(0) ' PX output
                ws.Cells(nextRow, "S").Value = "vectors"         ' output type
                ws.Cells(nextRow, "T").Value = "None"            ' parent
                nextRow = nextRow + 1
            Next
        End If
    End If
End Sub
Sub Worker2_Scan_Vectors_In_Vectors(ByVal json As String, ByRef nextRow As Long)
    Dim regEx As Object: Set regEx = CreateObject("VBScript.RegExp")
    Dim ws As Worksheet: Set ws = Sheets("Setup")
    Dim matches As Object, parentMatches As Object, pxMatches As Object
    Dim vivBlock As String, segmentText As String
    Dim i As Long, j As Long, startPos As Long, endPos As Long
    
    ' 1. Isolate the entire vectorsInVectors array
    ' Anchor adapted to look for timeDependentVectors or the end of the object
    regEx.Pattern = """vectorsInVectors""\s*:\s*\[([\s\S]*?)\]\s*,\s*""timeDependentVectors"""
    regEx.Global = False
    regEx.IgnoreCase = True
    
    Set matches = regEx.Execute(json)
    
    If matches.Count > 0 Then
        vivBlock = matches(0).subMatches(0)
        
        ' 2. Identify all Group Header (Parent) Positions within the ViV block
        Dim regExParent As Object: Set regExParent = CreateObject("VBScript.RegExp")
        ' Pattern for Group Names like policyInformation_1 UL2022
        regExParent.Pattern = """name""\s*:\s*""([^""]+)""\s*,\s*""vectors""\s*:\s*\["
        regExParent.Global = True
        Set parentMatches = regExParent.Execute(vivBlock)
        
        ' 3. Slice the block into positional segments
        For i = 0 To parentMatches.Count - 1
            Dim groupName As String: groupName = parentMatches(i).subMatches(0)
            
            ' Determine slice boundaries
            startPos = parentMatches(i).FirstIndex
            If i < parentMatches.Count - 1 Then
                endPos = parentMatches(i + 1).FirstIndex
            Else
                endPos = Len(vivBlock)
            End If
            
            ' Extract segment and find variable names inside
            segmentText = Mid(vivBlock, startPos + 1, endPos - startPos)
            
            Dim regExPX As Object: Set regExPX = CreateObject("VBScript.RegExp")
            regExPX.Pattern = """name""\s*:\s*""([^""]+)"""
            regExPX.Global = True
            Set pxMatches = regExPX.Execute(segmentText)
            
            ' Populate Excel (skip index 0 - the parent name)
            If pxMatches.Count > 1 Then
                For j = 1 To pxMatches.Count - 1
                    ws.Cells(nextRow, "R").Value = pxMatches(j).subMatches(0) ' PX output
                    ws.Cells(nextRow, "S").Value = "vectorsInVectors"        ' output type
                    ws.Cells(nextRow, "T").Value = groupName                 ' OutputParent
                    nextRow = nextRow + 1
                Next
            End If
        Next
    End If
End Sub
Sub Worker3_Scan_Time_Dependent_Vectors(ByVal json As String, ByRef nextRow As Long)
    Dim regEx As Object: Set regEx = CreateObject("VBScript.RegExp")
    Dim ws As Worksheet: Set ws = Sheets("Setup")
    Dim matches As Object, parentMatches As Object, pxMatches As Object
    Dim tdvBlock As String, segmentText As String
    Dim i As Long, j As Long, startPos As Long, endPos As Long
    
    ' 1. Isolate the entire timeDependentVectors (TDV) block
    ' Greedy capture ensures all data is included even if it's the last segment
    regEx.Pattern = """timeDependentVectors""\s*:\s*\[([\s\S]+)\]"
    regEx.Global = False
    regEx.IgnoreCase = True
    
    Set matches = regEx.Execute(json)
    
    If matches.Count > 0 Then
        tdvBlock = matches(0).subMatches(0)
        
        ' 2. Identify all Group Header (Parent) Positions within the TDV block
        Dim regExParent As Object: Set regExParent = CreateObject("VBScript.RegExp")
        regExParent.Pattern = """name""\s*:\s*""([^""]+)""\s*,\s*""vectors""\s*:\s*\["
        regExParent.Global = True
        Set parentMatches = regExParent.Execute(tdvBlock)
        
        ' 3. Slice the block into positional segments to map Children to Parents
        For i = 0 To parentMatches.Count - 1
            Dim groupName As String: groupName = parentMatches(i).subMatches(0)
            
            ' Determine slice boundaries (from current header to the start of the next header)
            startPos = parentMatches(i).FirstIndex
            If i < parentMatches.Count - 1 Then
                endPos = parentMatches(i + 1).FirstIndex
            Else
                ' Last segment (e.g., surrenderIllustration)
                endPos = Len(tdvBlock)
            End If
            
            ' Extract segment and find variable names (like asset value) inside
            segmentText = Mid(tdvBlock, startPos + 1, endPos - startPos)
            
            Dim regExPX As Object: Set regExPX = CreateObject("VBScript.RegExp")
            regExPX.Pattern = """name""\s*:\s*""([^""]+)"""
            regExPX.Global = True
            Set pxMatches = regExPX.Execute(segmentText)
            
            ' Populate Excel starting from index 1 (skipping the parent name itself)
            If pxMatches.Count > 1 Then
                For j = 1 To pxMatches.Count - 1
                    ws.Cells(nextRow, "R").Value = pxMatches(j).subMatches(0) ' PX output
                    ws.Cells(nextRow, "S").Value = "timeDependentVectors"     ' output type
                    ws.Cells(nextRow, "T").Value = groupName                 ' OutputParent
                    nextRow = nextRow + 1
                Next
            End If
        Next
    End If
End Sub
