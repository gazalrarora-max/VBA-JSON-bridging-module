Sub CalibratePXInput_ExactText()
    Dim fso As Object, jsonFile As Object
    Dim regEx As Object, matches As Object
    Dim filePath As Variant
    Dim lineText As String, keyName As String, valName As String
    Dim wsSetup As Worksheet, wsScript As Worksheet
    Dim lineCount As Long, outRow As Long

    ' 1. Select the PX JSON File
    filePath = Application.GetOpenFilename("JSON Files (*.json), *.json", Title:="Select PX JSON File")
    If filePath = False Then Exit Sub 

    Set wsSetup = ThisWorkbook.Sheets("Setup")
    Set wsScript = ThisWorkbook.Sheets("Script Format")
    
    ' 2. PREVENT AUTO-FORMATTING: Force Columns to Text
    ' Column K (Item), L (Line), and N (Sample Value)
    wsSetup.Range("K:K,L:L,N:N").NumberFormat = "@"
    
    ' 3. Initialize Objects
    Set fso = CreateObject("Scripting.FileSystemObject")
    Set regEx = CreateObject("VBScript.RegExp")
    
    regEx.Global = True
    regEx.IgnoreCase = True
    regEx.Pattern = """([^""]+)""\s*:\s*""?([^"",{} \s]+)""?"

    ' 4. Prepare Sheets
    outRow = 10
    wsSetup.Range("K10:L500").ClearContents
    wsSetup.Range("N10:N500").ClearContents 
    wsScript.Cells.Clear 
    
    ' 5. Read File Line-by-Line
    Set jsonFile = fso.OpenTextFile(filePath, 1) 
    lineCount = 0
    
    Application.ScreenUpdating = False
    Do Until jsonFile.AtEndOfStream
        lineCount = lineCount + 1
        lineText = jsonFile.ReadLine
        
        ' Store raw line in reference sheet (also forced to Text)
        wsScript.Cells(lineCount, 1).NumberFormat = "@"
        wsScript.Cells(lineCount, 1).Value = lineText
        
        If regEx.Test(lineText) Then
            Set matches = regEx.Execute(lineText)
            keyName = matches(0).SubMatches(0)
            valName = matches(0).SubMatches(1)
            
            ' Filter headers and null sets
            Select Case LCase(keyName)
                Case "id", "requestid", "deployment", "version", "name", "runtimeconfiguration"
                    ' Skip metadata
                Case Else
                    If LCase(valName) <> "null" And valName <> "[]" Then
                        wsSetup.Cells(outRow, 11).Value = keyName   ' Col K
                        wsSetup.Cells(outRow, 12).Value = lineCount ' Col L
                        wsSetup.Cells(outRow, 14).Value = valName   ' Col N: Sample Value
                        outRow = outRow + 1
                    End If
            End Select
        End If
    Loop
    jsonFile.Close
    Application.ScreenUpdating = True

    MsgBox "Extraction Complete. Data forced to Text format to prevent auto-conversion.", vbInformation
End Sub
