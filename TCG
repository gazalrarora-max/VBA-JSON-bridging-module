Sub Run_PX_TestCaseGenerator_Final()
    Dim wsSetup As Worksheet, wsTC As Worksheet, wsScript As Worksheet
    Dim pxPath As String, i As Long, j As Long, r As Long, tcID As String
    Dim jsonLines() As String, lastRowTC As Long, lastRowSetup As Long
    Dim targetLine As Long, mappingType As String, finalVal As Variant
    Dim formattedVal As String, currentLineText As String, originalValuePart As String
    
    Set wsSetup = ThisWorkbook.Sheets("Setup")
    Set wsTC = ThisWorkbook.Sheets("Test_Cases")
    Set wsScript = ThisWorkbook.Sheets("Script Format")
    
    If wsSetup.Range("SG_Check").Value <> "Pass" Then
        MsgBox "Integrity Check Failed (SG_Check).", vbCritical
        Exit Sub
    End If
    
    pxPath = ThisWorkbook.Sheets("Dashboard").Range("PX_TC").Value
    If Right(pxPath, 1) <> "\" Then pxPath = pxPath & "\"
    
    lastRowTC = wsTC.Cells(wsTC.Rows.Count, "A").End(xlUp).Row
    lastRowSetup = wsSetup.Cells(wsSetup.Rows.Count, "K").End(xlUp).Row
    
    For i = 6 To lastRowTC
        tcID = wsTC.Cells(i, 1).Value
        If Len(Trim(tcID)) = 0 Then Exit For
        
        ' Load fresh template into an array
        Dim lastRowScript As Long
        lastRowScript = wsScript.Cells(wsScript.Rows.Count, "A").End(xlUp).Row
        ReDim jsonLines(1 To lastRowScript)
        For r = 1 To lastRowScript
            jsonLines(r) = wsScript.Cells(r, 1).Value
        Next r
        
        Application.StatusBar = "Processing PX TC: " & tcID
        
        For j = 10 To lastRowSetup
            targetLine = Val(wsSetup.Cells(j, "L").Value)
            mappingType = wsSetup.Cells(j, "M").Value
            
            If targetLine > 0 And targetLine <= lastRowScript And mappingType <> "null" Then
                ' Determine Raw Value from TC or Fixed column
                If mappingType = "Fixed Value" Then
                    finalVal = wsSetup.Cells(j, "N").Value
                Else
                    Dim colIdx As Variant
                    colIdx = Application.Match(wsSetup.Cells(j, "M").Value, wsTC.Rows(5), 0)
                    If Not IsError(colIdx) Then finalVal = wsTC.Cells(i, colIdx).Value Else finalVal = ""
                End If

                ' DETECT TEMPLATE TYPE
                currentLineText = jsonLines(targetLine)
                If InStr(1, currentLineText, ":") > 0 Then
                    Dim prefix As String, suffix As String
                    prefix = Left(currentLineText, InStr(1, currentLineText, ":"))
                    suffix = IIf(Right(Trim(currentLineText), 1) = ",", ",", "")
                    
                    ' Extract the value part from the template to check for quotes
                    originalValuePart = Trim(Mid(currentLineText, InStr(1, currentLineText, ":") + 1))
                    If Right(originalValuePart, 1) = "," Then originalValuePart = Left(originalValuePart, Len(originalValuePart) - 1)
                    originalValuePart = Trim(originalValuePart)

                    ' If original has quotes, add quotes to new value. Else, leave raw.
                    If Left(originalValuePart, 1) = """" Then
                        formattedVal = """" & finalVal & """"
                    Else
                        ' Handle potential empty/null cases for literal fields
                        If Len(Trim(CStr(finalVal))) = 0 Then formattedVal = "null" Else formattedVal = Trim(CStr(finalVal))
                    End If
                    
                    ' Update line
                    jsonLines(targetLine) = prefix & " " & formattedVal & suffix
                End If
            End If
        Next j
        
        ' Save file
        Dim fileNum As Integer: fileNum = FreeFile
        Open pxPath & "TC_" & tcID & ".json" For Output As #fileNum
        For r = 1 To lastRowScript
            Print #fileNum, jsonLines(r)
        Next r
        Close #fileNum
    Next i
    
    Application.StatusBar = False
    MsgBox "PX Generation Complete! Success for " & (i - 6) & " cases."
End Sub
