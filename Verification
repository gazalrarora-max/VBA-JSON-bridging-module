Sub Generate_Report()
    Dim wsSetup As Worksheet, wsReport As Worksheet
    Dim pxPath As String, erPath As String, tcPrefix As String
    Dim tolerance As Double, lastRow As Long
    Dim pxFiles As New Collection, erFiles As New Collection
    Dim i As Long, maxTC As Long, pxMax As Long, erMax As Long, tcNum As Long
    Dim fso As Object: Set fso = CreateObject("Scripting.FileSystemObject")
    
    ' 1. Data Collection & Setup
    Set wsSetup = ThisWorkbook.Sheets("Setup")
    Set wsReport = ThisWorkbook.Sheets("Verification Report")
    pxPath = Range("PXOut_Path").Value
    erPath = Range("ER_Fol").Value
    tcPrefix = Range("PX_Header").Value
    tolerance = Range("Tolerance_Comp").Value
    lastRow = wsSetup.Cells(wsSetup.Rows.Count, "R").End(xlUp).Row
    
    ' 2. Clear Verification Report before starting
    Dim lastCol As Long: lastCol = wsReport.Cells(4, wsReport.Columns.Count).End(xlToLeft).Column
    Dim lastReportRow As Long: lastReportRow = wsReport.Cells(wsReport.Rows.Count, "B").End(xlUp).Row
    If lastCol < 5 Then lastCol = 5
    If lastReportRow < 6 Then lastReportRow = 6
    wsReport.Range(wsReport.Cells(4, 5), wsReport.Cells(lastReportRow + 100, lastCol + 100)).ClearContents
    
    ' 3. Import Mapping Data Arrays
    Dim mappingData As Variant: mappingData = wsSetup.Range("R10:U" & lastRow).Value
    Dim erMapping As Variant: erMapping = wsSetup.Range("F10:H" & lastRow).Value
    
    ' 4. Refresh Verification Headers
    For i = 1 To UBound(mappingData, 1)
        wsReport.Cells(4, i + 4).Value = mappingData(i, 2)
        wsReport.Cells(5, i + 4).Value = mappingData(i, 1)
    Next i
    
    ' 5. Index Files and Find Max TC Index
    Dim folderFile As Object
    pxMax = 0: erMax = 0
    For Each folderFile In fso.GetFolder(pxPath).Files
        If InStr(folderFile.Name, tcPrefix) > 0 Then 
            pxFiles.Add folder
