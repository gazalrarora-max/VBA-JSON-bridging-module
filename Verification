Sub Generate_Report()
    Dim wsSetup As Worksheet, wsReport As Worksheet
    Dim pxPath As String, erPath As String, tcPrefix As String
    Dim tolerance As Double, lastRow As Long
    Dim pxFiles As New Collection, erFiles As New Collection
    Dim i As Long, maxTC As Long
    Dim fso As Object: Set fso = CreateObject("Scripting.FileSystemObject")
    
    ' 1. Data Collection & Setup
    Set wsSetup = ThisWorkbook.Sheets("Setup")
    Set wsReport = ThisWorkbook.Sheets("Verification Report")
    pxPath = Range("PXOut_Path").Value
    erPath = Range("ER_Fol").Value
    tcPrefix = Range("PX_Header").Value
    tolerance = Range("Tolerance_Comp").Value
    lastRow = wsSetup.Cells(wsSetup.Rows.Count, "R").End(xlUp).Row
    
    ' 2. Clear Verification Report before starting
    Dim lastCol As Long: lastCol = wsReport.Cells(4, wsReport.Columns.Count).End(xlToLeft).Column
    Dim lastReportRow As Long: lastReportRow = wsReport.Cells(wsReport.Rows.Count, "B").End(xlUp).Row
    If lastCol < 5 Then lastCol = 5
    If lastReportRow < 6 Then lastReportRow = 6
    wsReport.Range(wsReport.Cells(4, 5), wsReport.Cells(lastReportRow + 100, lastCol + 100)).ClearContents
    
    ' 3. Import Mapping Data Arrays
    Dim mappingData As Variant: mappingData = wsSetup.Range("R10:U" & lastRow).Value
    Dim erMapping As Variant: erMapping = wsSetup.Range("F10:H" & lastRow).Value
    
    ' 4. Refresh Verification Headers
    For i = 1 To UBound(mappingData, 1)
        wsReport.Cells(4, i + 4).Value = mappingData(i, 2) ' Type (Col S)
        wsReport.Cells(5, i + 4).Value = mappingData(i, 1) ' PX Name (Col R)
    Next i
    
    ' 5. Index Files into Collections
    Dim folderFile As Object
    For Each folderFile In fso.GetFolder(pxPath).Files
        If InStr(folderFile.Name, tcPrefix) > 0 Then pxFiles.Add folderFile.Path, folderFile.Name
    Next folderFile
    For Each folderFile In fso.GetFolder(erPath).Files
        If InStr(folderFile.Name, "TC_") > 0 Then erFiles.Add folderFile.Path, folderFile.Name
    Next folderFile
    
    ' 6. Main Test Case Loop
    maxTC = IIf(pxFiles.Count > erFiles.Count, pxFiles.Count, erFiles.Count)
    
    For i = 1 To maxTC
        Dim currentPXKey As String: currentPXKey = tcPrefix & i & ".json" 
        Dim currentERKey As String: currentERKey = "TC_" & i & ".xlsx"
        Dim reportRow As Long: reportRow = 5 + i
        
        wsReport.Cells(reportRow, 2).Value = currentPXKey
        wsReport.Cells(reportRow, 3).Value = currentERKey
        
        ' 7. Availability Check
        Dim pxExists As Boolean, erExists As Boolean
        On Error Resume Next
        pxExists = (pxFiles(currentPXKey) <> "")
        erExists = (erFiles(currentERKey) <> "")
        On Error GoTo 0
        
        If pxExists And erExists Then
            ' 8. Open Files
            Dim jsonText As String: jsonText = fso.OpenTextFile(pxFiles(currentPXKey)).ReadAll
            Dim resultsWB As Workbook: Set resultsWB = Workbooks.Add
            Dim erWB As Workbook: Set erWB = Workbooks.Open(erFiles(currentERKey))
            
            ' 9. Identify JSON Sections
            Dim posVec As Long: posVec = InStr(jsonText, """vectors"":")
            Dim posTDV As Long: posTDV = InStr(jsonText, """timeDependentVectors"":")
            Dim posVIV As Long: posVIV = InStr(jsonText, """vectorsInVectors"":")
            Dim posTDVIV As Long: posTDVIV = InStr(jsonText, """timeDependentVectorInVectors"":")
            
            ' 10. Execute Comparison Sub-Macros
            Call Process_Vectors(resultsWB, erWB, jsonText, posVec, posTDV, _
                                mappingData, erMapping, tolerance, reportRow, wsReport)
            
            Call Process_VIV(resultsWB, erWB, jsonText, posVIV, posTDVIV, _
                             mappingData, erMapping, tolerance, reportRow, wsReport)
            
            Call Process_TDVIV(resultsWB, erWB, jsonText, posTDVIV, 0, _
                               mappingData, erMapping, tolerance, reportRow, wsReport)
            
            ' 11. Cleanup: Remove Blank Sheets, Status & Save
            Dim ws As Worksheet
            Application.DisplayAlerts = False 
            
            For Each ws In resultsWB.Worksheets
                If ws.UsedRange.Cells.Count = 1 And ws.Cells(1, 1).Value = "" Then
                    If resultsWB.Worksheets.Count > 1 Then ws.Delete
                End If
            Next ws

            wsReport.Cells(reportRow, 4).Value = "Done"
            wsReport.Cells(reportRow, 4).Font.Color = vbGreen

            Dim saveFolder As String: saveFolder = ThisWorkbook.Path & "\Detailed_Results"
            If fso.FolderExists(saveFolder) = False Then fso.CreateFolder(saveFolder)
            
            resultsWB.SaveAs Filename:=saveFolder & "\Result_TC" & i & ".xlsx"
            resultsWB.Close SaveChanges:=False
            erWB.Close SaveChanges:=False
            Application.DisplayAlerts = True
            
        ElseIf Not pxExists Then
            wsReport.Cells(reportRow, 4).Value = "No PX output generated"
        End If
    Next i
    
    MsgBox "Verification Process Complete.", vbInformation
End Sub
