Sub PX_Header_Controller()
    Dim wsSetup As Worksheet, wsReport As Worksheet
    Dim pxPath As String, erPath As String, tcPrefix As String
    Dim tolerance As Double, lastRow As Long
    Dim pxFiles As New Collection, erFiles As New Collection
    Dim i As Long, maxTC As Long
    Dim fso As Object: Set fso = CreateObject("Scripting.FileSystemObject")
    
    ' 1. Data Collection & Setup
    Set wsSetup = ThisWorkbook.Sheets("Setup")
    Set wsReport = ThisWorkbook.Sheets("Verification Report")
    pxPath = Range("PXOut_Path").Value
    erPath = Range("ER_Fol").Value
    tcPrefix = Range("PX_Header").Value
    tolerance = Range("Tolerance_Comp").Value
    lastRow = wsSetup.Cells(wsSetup.Rows.Count, "R").End(xlUp).Row
    
    ' 2. Verification Report Setup (Steps 3 & 10)
    For i = 10 To lastRow
        wsReport.Cells(4, i - 5).Value = wsSetup.Cells(i, "S").Value ' Output Type (X/S)
        wsReport.Cells(5, i - 5).Value = wsSetup.Cells(i, "R").Value ' PX Output Name
    Next i
    
    ' 3. List Available Files (Lists/Collections for easier checking)
    Dim folderFile As Object
    For Each folderFile In fso.GetFolder(pxPath).Files
        If InStr(folderFile.Name, tcPrefix) > 0 Then pxFiles.Add folderFile.Path, folderFile.Name
    Next folderFile
    
    For Each folderFile In fso.GetFolder(erPath).Files
        If InStr(folderFile.Name, "TC_") > 0 Then erFiles.Add folderFile.Path, folderFile.Name
    Next folderFile
    
    ' 4. Loop through Test Cases (Step 9)
    maxTC = IIf(pxFiles.Count > erFiles.Count, pxFiles.Count, erFiles.Count)
    
    For i = 1 To maxTC
        Dim currentPXKey As String: currentPXKey = tcPrefix & i & ".json" ' Cleaned naming
        Dim currentERKey As String: currentERKey = "TC_" & i & ".xlsx"    ' Fixed naming
        
        ' Populate Tracking
        wsReport.Cells(5 + i, 2).Value = currentPXKey
        wsReport.Cells(5 + i, 3).Value = currentERKey
        
        ' 5. Availability Check (Step 11)
        Dim pxExists As Boolean, erExists As Boolean
        On Error Resume Next
        pxExists = (pxFiles(currentPXKey) <> "")
        erExists = (erFiles(currentERKey) <> "")
        On Error GoTo 0
        
        If pxExists And erExists Then
            ' 6. Section Boundary Detection (Step 14)
            ' Using Get Output order: Vectors, TDV, FDV, VIV, TDVIV
            Dim jsonText As String: jsonText = fso.OpenTextFile(pxFiles(currentPXKey)).ReadAll
            Dim posVec As Long, posTDV As Long, posFDV As Long, posVIV As Long, posTDVIV As Long
            
            posVec = InStr(jsonText, """vectors"":")
            posTDV = InStr(jsonText, """timeDependentVectors"":")
            posFDV = InStr(jsonText, """frequencyDependentVectors"":")
            posVIV = InStr(jsonText, """vectorsInVectors"":")
            posTDVIV = InStr(jsonText, """timeDependentVectorInVectors"":")
            
            ' 7. Workbook Creation & File Opening (Step 12, 13, 15)
            Dim resultsWB As Workbook: Set resultsWB = Workbooks.Add
            Dim erWB As Workbook: Set erWB = Workbooks.Open(erFiles(currentERKey))
            
            ' Logic for Step 15/16 (Individual Vectors) would be called here
            ' Process_Vectors wsSetup, resultsWB, erWB, jsonText, posVec, posTDV
            
            ' erWB.Close SaveChanges:=False
        End If
    Next i
    
    MsgBox "Header Macro Complete: Lists generated and JSON sections positioned."
End Sub
