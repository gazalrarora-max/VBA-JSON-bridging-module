Sub Generate_Report()
    Dim wsSetup As Worksheet, wsReport As Worksheet
    Dim pxPath As String, erPath As String, tcPrefix As String
    Dim tolerance As Double, lastRow As Long
    Dim pxFiles As New Collection, erFiles As New Collection
    Dim i As Long, maxTC As Long, pxMax As Long, erMax As Long, tcNum As Long
    Dim fso As Object: Set fso = CreateObject("Scripting.FileSystemObject")
    
    ' 1. Data Collection & Setup
    Set wsSetup = ThisWorkbook.Sheets("Setup")
    Set wsReport = ThisWorkbook.Sheets("Verification Report")
    pxPath = Range("PXOut_Path").Value
    erPath = Range("ER_Fol").Value
    tcPrefix = Range("PX_Header").Value
    tolerance = Range("Tolerance_Comp").Value
    lastRow = wsSetup.Cells(wsSetup.Rows.Count, "R").End(xlUp).Row
    
    ' 2. Clear Verification Report before starting
    Dim lastCol As Long: lastCol = wsReport.Cells(4, wsReport.Columns.Count).End(xlToLeft).Column
    Dim lastReportRow As Long: lastReportRow = wsReport.Cells(wsReport.Rows.Count, "B").End(xlUp).Row
    If lastCol < 5 Then lastCol = 5
    If lastReportRow < 6 Then lastReportRow = 6
    wsReport.Range(wsReport.Cells(4, 5), wsReport.Cells(lastReportRow + 100, lastCol + 100)).ClearContents
    
    ' 3. Import Mapping Data Arrays
    Dim mappingData As Variant: mappingData = wsSetup.Range("R10:U" & lastRow).Value
    Dim erMapping As Variant: erMapping = wsSetup.Range("F10:H" & lastRow).Value
    
    ' 4. Refresh Verification Headers
    For i = 1 To UBound(mappingData, 1)
        wsReport.Cells(4, i + 4).Value = mappingData(i, 2)
        wsReport.Cells(5, i + 4).Value = mappingData(i, 1)
    Next i
    
    ' 5. Index Files and Find Max TC Index
    Dim folderFile As Object
    pxMax = 0: erMax = 0
    For Each folderFile In fso.GetFolder(pxPath).Files
        If InStr(folderFile.Name, tcPrefix) > 0 Then 
            pxFiles.Add folderFile.Path, folderFile.Name
            tcNum = Val(Replace(Replace(folderFile.Name, tcPrefix, ""), ".json", ""))
            If tcNum > pxMax Then pxMax = tcNum
        End If
    Next folderFile
    For Each folderFile In fso.GetFolder(erPath).Files
        If InStr(folderFile.Name, "TC_") > 0 Then 
            erFiles.Add folderFile.Path, folderFile.Name
            tcNum = Val(Replace(Replace(folderFile.Name, "TC_", ""), ".xlsx", ""))
            If tcNum > erMax Then erMax = tcNum
        End If
    Next folderFile
    
    ' 6. Main Loop
    maxTC = IIf(pxMax > erMax, pxMax, erMax)
    For i = 1 To maxTC
        Dim currentPXKey As String: currentPXKey = tcPrefix & i & ".json" 
        Dim currentERKey As String: currentERKey = "TC_" & i & ".xlsx"
        Dim reportRow As Long: reportRow = 5 + i
        wsReport.Cells(reportRow, 2).Value = currentPXKey
        wsReport.Cells(reportRow, 3).Value = currentERKey
        
        Dim pxExists As Boolean: pxExists = False
        Dim erExists As Boolean: erExists = False
        On Error Resume Next
        pxExists = (pxFiles(currentPXKey) <> "")
        erExists = (erFiles(currentERKey) <> "")
        On Error GoTo 0
        
        If pxExists And erExists Then
            Dim jsonText As String: jsonText = fso.OpenTextFile(pxFiles(currentPXKey)).ReadAll
            Dim resultsWB As Workbook: Set resultsWB = Workbooks.Add
            Dim erWB As Workbook: Set erWB = Workbooks.Open(erFiles(currentERKey))
            
            ' 9. Identify Sections
            Dim pV As Long: pV = InStr(jsonText, """vectors"":")
            Dim pTDV As Long: pTDV = InStr(jsonText, """timeDependentVectors"":")
            Dim pVIV As Long: pVIV = InStr(jsonText, """vectorsInVectors"":")
            Dim pTDVIV As Long: pTDVIV = InStr(jsonText, """timeDependentVectorInVectors"":")
            
            ' 10. Call Sub-Macros
            ' Passing Len(jsonText) to TDVIV to ensure accurate slicing of the final block
            Call Process_Vectors(resultsWB, erWB, jsonText, pV, pTDV, mappingData, erMapping, tolerance, reportRow, wsReport)
            Call Process_VIV(resultsWB, erWB, jsonText, pVIV, pTDVIV, mappingData, erMapping, tolerance, reportRow, wsReport)
            Call Process_TDVIV(resultsWB, erWB, jsonText, pTDVIV, Len(jsonText), mappingData, erMapping, tolerance, reportRow, wsReport)
            
            ' 11. Cleanup & Save
            Dim ws As Worksheet: Application.DisplayAlerts = False
            For Each ws In resultsWB.Worksheets
                If ws.UsedRange.Cells.Count = 1 And ws.Cells(1, 1).Value = "" Then
                    If resultsWB.Worksheets.Count > 1 Then ws.Delete
                End If
            Next ws
            wsReport.Cells(reportRow, 4).Value = "Done"
            wsReport.Cells(reportRow, 4).Font.Color = vbGreen
            
            Dim sFol As String: sFol = ThisWorkbook.Path & "\Detailed_Results"
            If fso.FolderExists(sFol) = False Then fso.CreateFolder(sFol)
            resultsWB.SaveAs sFol & "\Result_TC" & i & ".xlsx": resultsWB.Close: erWB.Close: Application.DisplayAlerts = True
        Else
            wsReport.Cells(reportRow, 4).Value = IIf(Not pxExists, "PX Missing", "ER Missing"): wsReport.Cells(reportRow, 4).Font.Color = vbRed
        End If
    Next i
    MsgBox "Verification Complete!"
End Sub
