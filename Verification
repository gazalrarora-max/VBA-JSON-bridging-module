Sub Generate_Report()
    Dim wsSetup As Worksheet, wsReport As Worksheet
    Dim pxPath As String, erPath As String, tcPrefix As String
    Dim tolerance As Double, lastRow As Long
    Dim pxFiles As New Collection, erFiles As New Collection
    Dim i As Long, maxTC As Long
    Dim fso As Object: Set fso = CreateObject("Scripting.FileSystemObject")
    
    ' 1. Data Collection & Setup
    Set wsSetup = ThisWorkbook.Sheets("Setup")
    Set wsReport = ThisWorkbook.Sheets("Verification Report")
    pxPath = Range("PXOut_Path").Value
    erPath = Range("ER_Fol").Value
    tcPrefix = Range("PX_Header").Value
    tolerance = Range("Tolerance_Comp").Value
    lastRow = wsSetup.Cells(wsSetup.Rows.Count, "R").End(xlUp).Row
    
    ' --- NEW SEGMENT: Import Data R to U for Further Use ---
    ' This stores the mapping context (PX Output, Type, Parent, Calc Name) in memory
    Dim mappingData As Variant
    mappingData = wsSetup.Range("R10:U" & lastRow).Value
    ' ------------------------------------------------------

    ' --- NEW SEGMENT: Extract Columns E to H for ER Mapping ---
    ' Index 1: Test Case Header, 2: Sheet Name (Inputs), 3: Sheet Name (Outputs), 4: Range/Cell
    Dim erMapping As Variant
    erMapping = wsSetup.Range("E10:H" & lastRow).Value
    ' ----------------------------------------------------------
    
    ' 2. Verification Report Setup
    For i = 10 To lastRow
        wsReport.Cells(4, i - 5).Value = wsSetup.Cells(i, "S").Value 
        wsReport.Cells(5, i - 5).Value = wsSetup.Cells(i, "R").Value 
    Next i
    
    ' 3. List Available Files
    Dim folderFile As Object
    For Each folderFile In fso.GetFolder(pxPath).Files
        If InStr(folderFile.Name, tcPrefix) > 0 Then pxFiles.Add folderFile.Path, folderFile.Name
    Next folderFile
    
    For Each folderFile In fso.GetFolder(erPath).Files
        If InStr(folderFile.Name, "TC_") > 0 Then erFiles.Add folderFile.Path, folderFile.Name
    Next folderFile
    
    ' 4. Loop through Test Cases
    maxTC = IIf(pxFiles.Count > erFiles.Count, pxFiles.Count, erFiles.Count)
    
    For i = 1 To maxTC
        Dim currentPXKey As String: currentPXKey = tcPrefix & i & ".json" 
        Dim currentERKey As String: currentERKey = "TC_" & i & ".xlsx"    
        
        ' Populate Tracking
        wsReport.Cells(5 + i, 2).Value = currentPXKey
        wsReport.Cells(5 + i, 3).Value = currentERKey
        
        ' 5. Availability Check
        Dim pxExists As Boolean, erExists As Boolean
        On Error Resume Next
        pxExists = (pxFiles(currentPXKey) <> "")
        erExists = (erFiles(currentERKey) <> "")
        On Error GoTo 0
        
        If pxExists And erExists Then
            ' 6. Section Boundary Detection
            Dim jsonText As String: jsonText = fso.OpenTextFile(pxFiles(currentPXKey)).ReadAll
            Dim posVec As Long, posTDV As Long, posFDV As Long, posVIV As Long, posTDVIV As Long
            
            posVec = InStr(jsonText, """vectors"":")
            posTDV = InStr(jsonText, """timeDependentVectors"":")
            posFDV = InStr(jsonText, """frequencyDependentVectors"":")
            posVIV = InStr(jsonText, """vectorsInVectors"":")
            posTDVIV = InStr(jsonText, """timeDependentVectorInVectors"":")
            
            ' 7. Workbook Creation & File Opening
            Dim resultsWB As Workbook: Set resultsWB = Workbooks.Add
            Dim erWB As Workbook: Set erWB = Workbooks.Open(erFiles(currentERKey))
            
            ' Next steps will pass mappingData and erMapping to sub-macros
            
            ' erWB.Close SaveChanges:=False
        End If
    Next i
    
    MsgBox "Report Generation Complete: Both mapping arrays loaded."
End Sub
