Sub RunCRREngine()
    Dim engineWS As Worksheet
    Dim dataWB As Workbook
    Dim dataWS As Worksheet
    Dim dataFilePath As String
    Dim lastRow As Long, iRow As Long
    Dim scoreCol As Long, ratingCol As Long
    Dim mapRange As Range, cell As Range
    Dim colRef As String, targetRangeName As String
    Dim riskRow As Integer
    
    Set engineWS = ThisWorkbook.Sheets("Automation")
    
    ' 1. Get Data File Path
    dataFilePath = engineWS.Range("D4").Value
    
    ' 2. Define the Mapping Table Range 
    ' (Based on your list: C11 to C57 covers the column references)
    ' We will use a custom array to handle the non-linear jumps in your table
    Dim colMapAddresses As Variant
    Dim extractionAddresses As Variant
    
    colMapAddresses = Array("C11", "D11", "C15", "C21", "C26", "C31", "C36", "C41", "C46", "C51", "C56", "C36")
    extractionAddresses = Array("PEP_1", "PEP_2", "Sanc_1", "C22", "C27", "C32", "C37", "C42", "C47", "C52", "C57", "C37")

    ' 6. Open the data file
    On Error Resume Next
    Set dataWB = Workbooks.Open(dataFilePath)
    On Error GoTo 0
    
    If dataWB Is Nothing Then
        MsgBox "Could not find file: " & dataFilePath, vbCritical
        Exit Sub
    End If
    
    Set dataWS = dataWB.Sheets(1)
    
    ' 7 & 8. Identify boundaries and Add Headers
    lastRow = dataWS.Cells(dataWS.Rows.Count, 1).End(xlUp).Row
    scoreCol = dataWS.Cells(1, dataWS.Columns.Count).End(xlToLeft).Column + 1
    ratingCol = scoreCol + 1
    
    dataWS.Cells(1, scoreCol).Value = "CRR Score"
    dataWS.Cells(1, ratingCol).Value = "CRR Rating"
    
    ' Optimization
    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual
    
    ' 7. Loop for each row (Case)
    For iRow = 2 To lastRow
        
        ' 9. Process each of the 12 risks
        For riskRow = LBound(colMapAddresses) To UBound(colMapAddresses)
            
            ' Get column letter/number from the engine (Step 3)
            colRef = engineWS.Range(colMapAddresses(riskRow)).Value
            targetRangeName = extractionAddresses(riskRow)
            
            ' 4. If mapping is blank, clear target and skip
            If colRef = "" Then
                engineWS.Range(targetRangeName).Value = ""
            Else
                ' Extract from Data file to Engine
                engineWS.Range(targetRangeName).Value = dataWS.Cells(iRow, colRef).Value
            End If
        Next riskRow
        
        ' 10. Calculate Engine
        Application.Calculate
        
        ' 11. Store Results back in Data File
        dataWS.Cells(iRow, scoreCol).Value = engineWS.Range("Overall_Score").Value
        dataWS.Cells(iRow, ratingCol).Value = engineWS.Range("Overall_Rating").Value
        
    Next iRow
    
    ' 12. Save and Clean up
    dataWB.Save
    
    Application.Calculation = xlCalculationAutomatic
    Application.ScreenUpdating = True
    
    ' 13. Completion Message
    MsgBox "Process Complete! " & (lastRow - 1) & " cases updated in " & dataWB.Name, vbInformation
    
End Sub
